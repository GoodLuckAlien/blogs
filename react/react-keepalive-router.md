# ä»äº§å“éœ€æ±‚åˆ°å·¥å…·åŒ…å¼€æºå…¨æµç¨‹ï¼Œreactç¼“å­˜è·¯ç”±å®æˆ˜-react-keepalive-router(ä¼˜å…ˆçº§****)ã€‚

ã€Œreactç¼“å­˜é¡µé¢ã€ä»éœ€æ±‚åˆ°å¼€æºï¼ˆæˆ‘æ˜¯æ€ä¹ˆæ ·è®©äº§å“å°å§å§åˆ®ç›®ç›¸çœ‹çš„ï¼‰

## ä¸€åˆ‡æ ¹æºéƒ½ä»äº§å“å°å§å§æ— å˜å¤´éœ€æ±‚å¼€å§‹

æœ€è¿‘åœ¨å¼€å‘ä¸šåŠ¡é¡¹ç›®çš„æ—¶å€™ï¼Œäº§å“å°å§å§çªç„¶æ¥åˆ°æˆ‘èº«è¾¹ï¼Œç„¶åå°±å¯¹ç€ç”µè„‘ä¸€é¡¿æ“ä½œï¼Œå…·ä½“åœºæ™¯å¤§è‡´æ˜¯è¿™æ ·çš„ã€‚

åœºæ™¯ä¸€ï¼š



å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“åœ¨æ•°ä¸‡çº§åˆ«çš„æ•°æ®ä¸­ï¼Œé€‰æ‹©ä¸€æ¡ï¼Œç‚¹å‡»**æŸ¥çœ‹**ï¼Œè·³è½¬åˆ°å½“å‰æ•°æ®çš„è¯¦æƒ…é¡µï¼Œå½“ç‚¹å‡»æŒ‰é’®**è¿”å›**è¿”å›æ¥ï¼Œæˆ–è€…æ˜¯æµè§ˆå™¨å‰è¿›åé€€ç­‰å…¶ä»–æ“ä½œï¼Œè¿”å›åˆ°åˆ—è¡¨é¡µçš„æ—¶å€™ã€‚è¦è®°å½•å½“å‰åˆ—è¡¨çš„ä½ç½®ã€‚ä¹Ÿå°±æ˜¯è¦è¿˜åŸç‚¹å‡»æŸ¥çœ‹**æŸ¥çœ‹**å‰çš„é¡µé¢ã€‚ä½†æ˜¯å½“ç‚¹å‡»tabèœå•æŒ‰é’®çš„æ—¶å€™ï¼Œè¦æ¸…é™¤é¡µé¢ä¿¡æ¯ã€‚



åœºæ™¯äºŒï¼š


å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œå½“æˆ‘ä»¬ç¼–è¾‘å†…å®¹çš„æ—¶å€™ï¼Œä¸€äº›æ•°æ®å¯èƒ½ä»å…¶ä»–é¡µé¢è·å¾—ï¼Œæ‰€ä»¥è¦æ±‚ï¼Œæ— è®ºåˆ‡æ¢è·¯ç”±ï¼Œåˆ‡æ¢é¡µé¢ï¼Œå½“å‰é¡µé¢çš„ç¼–è¾‘ä¿¡æ¯å‡ä¸èƒ½è¢«ç½®ç©ºï¼Œåªæœ‰ç‚¹å‡»**ç¡®å®š** ï¼Œ**é‡ç½®**ï¼Œè¡¨å•æ‰å†…å®¹ç½®ç©ºã€‚


åœºæ™¯ä¸‰ï¼š åœºæ™¯ä¸€ + åœºæ™¯äºŒ æ˜¯æ›´å¤æ‚çš„ç¼“å­˜é¡µé¢ä¿¡æ¯åœºæ™¯ã€‚

## æ¢³ç†éœ€æ±‚


æ¥è¿™ä¸ªéœ€æ±‚çš„æ—¶å€™ï¼Œå’‹çœ¼ä¸€çœ‹ï¼Œ**what** ï¼Œå¥½åƒæ˜¯ `vue` ä¸­çš„ `keepalive` + `vue router`åŠŸèƒ½ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬å‡ ä¸ªé¡¹ç›®æŠ€æœ¯æ ˆæ˜¯`react` ,`react` , `react`! `react` ä¸­æ²¡æœ‰å¯¹åº”çš„ `keepalive`å†…ç½® `api`,åæ¥ä¸Š`GitHub`ä¸Šæœç´¢ç›¸å…³é¡¹ç›®ï¼Œæ„Ÿè§‰æœ‰å¾ˆå¤šä¸ç¬¦åˆä¸šåŠ¡éœ€æ±‚çš„æƒ…å†µã€‚è¿˜æœ‰ä¸€äº›æ½œåœ¨çš„é£é™©ã€‚ ç¬é—´æ…Œäº†ï½ï½ï½ã€‚å†…å¿ƒæœ‰ä¸€ç§ä¸‡åªç¥å…½å¥”è…¾çš„æ„Ÿè§‰ã€‚

åœ¨äº§å“å°å§å§é¢å‰ï¼Œæ€ä¹ˆèƒ½è¯´ä¸ï¼Œé‚£ä¸æ˜¾å¾—ç ”å‘èƒ½åŠ›å·®ï¼Œåªèƒ½ç¡¬ç€å¤´çš®æ¥ä¸‹æ¥äº†ã€‚æœ€åäº§å“å°å§å§é¬¼é­…çš„å‘æˆ‘ç¬‘äº†ç¬‘ï¼Œè¯´å‡ ä¸ªé¡¹ç›®çš„ä¸€äº›åŠŸèƒ½æ€§é¡µé¢éƒ½è¦åŠ ä¸Šã€‚

äºæ˜¯ä¹å¼€å§‹ç¢ç£¨è§£å†³æ–¹æ¡ˆã€‚

### åˆ†æåŠŸèƒ½

æ—¢ç„¶æ‰“ç®—å¼€å‘ï¼Œè‡ªå·±é€‰æ‹©çš„å‘ï¼Œé—­ç€çœ¼ç›ä¹Ÿè¦è¸©ç©ğŸ˜­ğŸ˜­ğŸ˜­ï¼Œæ‰€ä»¥æ‰“ç®—å¼€å§‹æ¢³ç†é‡éš¾ç‚¹ã€‚é¦–å…ˆåˆ†æåŸºæœ¬åŠŸèƒ½å®ç°ã€‚

**1 å› ä¸ºæˆ‘ä»¬çš„åˆ‡æ¢è·¯ç”±éƒ½æ˜¯åœ¨é¡µé¢å±‚çº§ä¸Šï¼Œæ‰€ä»¥éœ€è¦å¯¹é¡µé¢çš„æ•°æ®çŠ¶æ€stateå±‚ï¼Œå’Œå…ƒç´ viewè§†å›¾å±‚åšç¼“å­˜ã€‚**

**2 å› ä¸ºå¯¹ç¼“å­˜çš„æ§åˆ¶æ¯”è¾ƒçµæ´»ï¼Œéœ€è¦è·å–ç¼“å­˜çš„çŠ¶æ€ï¼Œå’Œæ‰‹åŠ¨æ¸…é™¤ç¼“å­˜ã€‚**

**3 ç¼“å­˜åŠŸèƒ½éœ€è¦å¢åŠ ä¸€äº›ç›‘å¬å‡½æ•°ã€‚**

### è§£å†³æ–¹æ¡ˆ


#### 1 æ•°æ®çŠ¶æ€ç¼“å­˜åˆ°å…¬å…±ç®¡ç†å¯è¡Œæ€§

è¿™ä¸ªéœ€æ±‚é¦–å…ˆè®©æˆ‘æƒ³åˆ°çš„æ˜¯ç”¨`redux`æˆ–è€…æ˜¯`mobx`æ¥æŠŠé¡µé¢çš„çŠ¶æ€ç¼“å­˜èµ·æ¥ï¼Œç„¶ååˆ‡æ¢é¡µé¢çš„æ—¶å€™ï¼ŒæŠŠè¿™äº›æ•°æ®ç¼“å­˜è¿›å»ï¼Œå†æ¬¡åˆ‡æ¢å›æ¥çš„æ—¶å€™ï¼Œå°†æ•°æ®å–å‡ºæ¥ï¼Œè¿™æ ·å°±ä¸€ä¸ªé—®é¢˜ï¼Œå³ä¾¿èƒ½ç¼“å­˜`state`å±‚ï¼Œä½†æ˜¯å¦‚æœä¸€äº›è¡¨å•ç»„ä»¶æ˜¯éå—æ§ç»„ä»¶ï¼Œæ˜¯æ— æ³•ç¼“å­˜ä¸‹æ¥çš„ï¼Œè¿˜æœ‰ä¸€äº›`dom`çŠ¶æ€æ˜¯ç¼“å­˜ä¸äº†çš„ï¼Œæ¯”å¦‚æ‰‹åŠ¨æ·»åŠ çš„ä¸€äº›æ ·å¼ç­‰ã€‚è¿˜æœ‰å°±æ˜¯å®é™…æƒ…å†µæ¯”è¾ƒå¤æ‚ï¼Œæœ‰å¯Œæ–‡æœ¬ç»„ä»¶ï¼Œä½ æ˜¯æ— æ³•ç›´æ¥è·å–ç»‘å®šçš„`state`çš„ã€‚

ç¬¬äºŒä¸ªåŸå› å°±æ˜¯æœ‰å¥½å‡ ä¸ªé¡¹ç›®ï¼Œè€Œä¸”é¡µé¢æ¯”è¾ƒå¤šï¼Œå¦‚æœéƒ½å»ºç«‹æ•°æ®ç®¡ç†ï¼Œé‚£ä¹ˆå·¥ä½œé‡ä¼šéå¸¸çš„å¤§ã€‚
æ‰€ä»¥æ•°æ®çŠ¶æ€ç¼“å­˜çš„å¯è¡Œæ€§ä¸é«˜ï¼Œå³ä¾¿å¯ä»¥å®ç°ï¼Œä¹Ÿéœ€è¦å¤§é‡çš„å¤åˆ¶ç²˜è´´ï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬çš„è¿½æ±‚ã€‚

#### 2 react-keepalive-routerè¯ç”Ÿ

æ‰€ä»¥æˆ‘ä»¬åªèƒ½é€‰æ‹©è‡ªå·±å¼€å‘ä¸€ä¸ªé¡¹ç›®ï¼Œç„¶åæŠŠå®ƒå¼€æºï¼Œå¹¶åº”ç”¨åœ¨å…¬å¸é¡¹ç›®ä¸­æ¥ã€‚æ—¢ç„¶é€‰æ‹©ç¼“å­˜é¡µé¢ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆä¸åœ¨`react-router`ä¸­çš„ `Route`ç»„ä»¶å’Œ`Switch`ç»„ä»¶ä¸­åšæ–‡ç« å‘¢ï¼Œæˆ‘ä»¬éœ€è¦å¯¹`Route` å’Œ `Switch` ç»„ä»¶åšä¸€äº›åŠŸèƒ½æ€§çš„æ‹“å±•ï¼Œæ­£å¥½ç¬”è€…ä¹‹å‰è‡ªå·±ç ”ç©¶è¿‡`react-router`æºç ï¼Œå¹¶å†™äº†ä¸€ç¯‡(è¿™ä¸€æ¬¡å½»åº•å¼„æ‡‚react-routerè·¯ç”±åŸç†)[https://juejin.cn/post/6886290490640039943#comment] ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ä¸‰è¿ä¸€æ³¢ï¼Œå› ä¸ºé¡¹ç›®æ˜¯åœ¨`router`è·¯ç”±å±‚é¢ï¼Œæ‰€ä»¥ç»™å®ƒèµ·äº†ä¸€ä¸ªåå­—`react-keepalive-router`ã€‚æ¥ä¸‹æ¥å°±è¦å¯¹æ•´ä¸ªé¡¹ç›®åšä¸€ä¸ªç³»ç»Ÿçš„è®¾è®¡ã€‚

## è®¾è®¡é˜¶æ®µ



### äº†è§£react-fiber

ä¸ºä»€ä¹ˆæˆ‘ä»¬çš„é¡¹ç›®è¦æåˆ°`react-fiber`å‘¢ï¼Œè¿™é‡Œæˆ‘å…ˆè¯´ä¸€ä¸‹ï¼Œ`react-fiber`ï¼Œ `React Fiber` æ˜¯ä» v16 ç‰ˆæœ¬å¼€å§‹å¯¹ `Stack Reconciler` è¿›è¡Œçš„é‡å†™ï¼Œæ˜¯ v16 ç‰ˆæœ¬çš„æ ¸å¿ƒç®—æ³•å®ç°ã€‚`react`åœ¨åˆå§‹åŒ–æ„å»ºè¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿä¸€ä¸ªç”±`child`æŒ‡å‘å­`fiber`,`sibling`æŒ‡å‘å…„å¼Ÿ`fiber`,`return`æŒ‡å‘çˆ¶`fiber`ä¸‰ä¸ªæŒ‡é’ˆæ„å»ºçš„`fiber`æ ‘ç»“æ„ï¼Œé‡Œé¢ä¿å­˜ç€`dom`ä¿¡æ¯ï¼Œ`update`ä¿¡æ¯ï¼Œ`props`ä¿¡æ¯ç­‰ï¼Œæˆ‘ä»¬æ ¸å¿ƒæ€æƒ³å°±æ˜¯ï¼Œåœ¨åˆ‡æ¢é¡µé¢çš„æ—¶å€™,ç»„ä»¶é”€æ¯ï¼Œä½†æ˜¯ä½œä¸ºæ¸²æŸ“è°ƒåº¦çš„`react fiber`ä¿å­˜`keepalive`çŠ¶æ€ã€‚åªè¦`fiber`å­˜æ´»ï¼Œå°±èƒ½è·å–åˆ°`dom`å…ƒç´ ï¼Œæ•°æ®å±‚`state`ç­‰ä¿¡æ¯ã€‚



### åŸºäº react-router-dom  å’Œ react 16.8 

é¦–å…ˆæˆ‘ä»¬éœ€è¦å¯¹`react-router`åº“ä¸­çš„ `Route`ç»„ä»¶å’Œ`Switch`ç»„ä»¶ä½œå‡ºæ”¹é€ ï¼Œå¯ä»¥é€šè¿‡è·¯ç”±å±‚é¢å®ç°ç¼“å­˜è·¯ç”±åŠŸèƒ½ã€‚å› ä¸ºåœ¨è®¾è®¡ä¹‹åˆï¼Œæˆ‘å°±æƒ³ç€å°†ç”¨ä¸åŒçš„çŠ¶æ€ç®¡ç†`keepalive`çŠ¶æ€ï¼Œè¿™æ ·çš„å¥½å¤„æ˜¯ï¼Œåç»­å¯ä»¥ç»™ç¼“å­˜è·¯ç”±ç»„ä»¶ï¼Œå¢åŠ ä¸€äº›é¢å¤–çš„å£°æ˜å‘¨æœŸï¼Œæ¯”å¦‚è¯´`vue`ä¸­ `activated` å’Œ `deactivated`ä¸€æ ·ã€‚å› ä¸ºè®¾è®¡æ€æƒ³æ˜¯çŠ¶æ€ç®¡ç†ï¼Œé¡¹ç›®ä¾èµ–ä¸­ä¸æƒ³å¼•å…¥`redux`ç­‰ç¬¬ä¸‰æ–¹åº“ï¼Œæ‰€ä»¥è¿™é‡Œé€‰äº†`react-hooks`ä¸­ `useReducer`æ°åˆ°å¥½å¤„ã€‚è¿™å°±æ˜¯`react`åŸºç¡€åº“ `16.8+`çš„åŸå› ä¹‹ä¸€ã€‚å¦å¤–ä¸€ä¸ªåŸå› å°±æ˜¯`hooks`ä¸­æœ‰`useMemo`è¿™æ ·é˜²æ­¢æ¸²æŸ“ç©¿é€çš„api,æœ‰åŠ©äºè°ƒèŠ‚è·¯ç”±ç»„ä»¶çš„æ›´æ–°æ¬¡æ•°ã€‚


### å·¥ä½œæµç¨‹åˆ†æ

å—åˆ°`react-router-cache-route`å¼€æºé¡¹ç›®çš„å¯å‘ï¼Œæˆ‘åœ¨è®¾è®¡æ•´ä¸ªæµç¨‹çš„æ—¶å€™ï¼Œé‡‡å–äº†**äº¤æ¢`dom`æ ‘**çš„æ–¹å¼ã€‚

 **åˆå§‹åŒ–** ï¼š æ•´ä½“è®¾è®¡æ€è·¯ç¬¬ä¸€æ¬¡åˆ‡å…¥ç¼“å­˜é¡µé¢çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ç”Ÿæˆä¸€ä¸ªå®¹å™¨ç»„ä»¶ï¼Œç¼“å­˜`Route`ä¼šæŠŠç»„ä»¶ï¼Œäº¤ç»™å®¹å™¨ç»„ä»¶æ¥æŒ‚è½½ï¼Œç„¶åå®¹å™¨ç»„ä»¶ç”Ÿæˆ`fiber`,`render`ä¹‹åç”Ÿæˆå¯¹åº”çš„`dom`æ ‘ï¼Œå°†`dom`æ ‘äº¤ç»™`Route`ç»„ä»¶ï¼ˆä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„æ­£å¸¸çš„é¡µé¢ï¼‰ã€‚

**åˆ‡æ¢é¡µé¢**ï¼š åˆ‡æ¢é¡µé¢çš„æ—¶å€™ï¼Œè·¯ç”±ç»„ä»¶æ˜¯è‚¯å®šå¸è½½çš„ï¼Œè¿™æ—¶å€™éœ€è¦å°†æˆ‘ä»¬çš„`dom`è¿˜ç»™å®¹å™¨ç»„ä»¶ï¼Œç„¶åå®¹å™¨ç»„ä»¶è¿›å…¥å†»ç»“çŠ¶æ€ã€‚


**å†æ¬¡åˆ‡æ¢åˆ°ç¼“å­˜é¡µé¢**ï¼šå†æ¬¡è¿›å…¥è·¯ç”±é¡µé¢çš„æ—¶å€™,é¦–å…ˆä»å®¹å™¨ä¸­ï¼Œå‘ç°æœ‰è¯¥é¡µé¢çš„ç¼“å­˜ï¼Œé‚£ä¹ˆå°†å®¹å™¨è§£å°çŠ¶æ€ï¼Œç„¶åå°†`dom`æ ‘ï¼Œè¿˜ç»™å½“å‰è·¯ç”±é¡µé¢ã€‚å®Œæˆ`keepalive`çŠ¶æ€ã€‚


**ç¼“å­˜é”€æ¯ï¼š**ï¼š é¡¹ç›®æ”¯æŒé”€æ¯ç¼“å­˜åŠŸèƒ½ï¼Œè°ƒç”¨é”€æ¯æ–¹æ³•,ä¼šå¸è½½å½“å‰ç¼“å­˜å®¹å™¨ï¼Œè¿›ä¸€æ­¥é”€æ¯`fiber` å’Œ `dom` ï¼Œå®Œæˆæ•´ä¸ªé”€æ¯åŠŸèƒ½ã€‚


#### å·¥ä½œæµç¨‹å›¾



åŠ å…¥äº†`created` , `active`, `actived` , `unactive` , `unactived`, `destory` ,`destoryed` ç¼“å­˜çŠ¶æ€ï¼Œå’Œç»„ä»¶çš„ç”Ÿå‘½å‘¨æœŸæœ‰ç€ç›¸äº’çš„å¯¹åº”å…³ç³»ã€‚



### å·¥ä½œåŸç†åˆ†æ







### è®¾è®¡çš„ä¼˜åŠ¿åœ¨å“ªé‡Œï¼Ÿ

è®¾è®¡ä¼˜åŠ¿ï¼š

1 å› ä¸ºå†…éƒ¨è¿ç”¨äº† `useReducer` çŠ¶æ€ç®¡ç†ï¼Œç®¡ç†ç¼“å­˜çŠ¶æ€ï¼Œå¯ä»¥æ›´çµæ´»ï¼Œæ“çºµç¼“å­˜è·¯ç”±ç»„ä»¶ï¼Œé‡‡ç”¨`react hooks`å…¨æ–°`api`,æ¸²æŸ“èŠ‚æµï¼Œæ‰‹åŠ¨è§£é™¤ç¼“å­˜ï¼Œå¢åŠ äº†ç¼“å­˜çš„çŠ¶æ€å‘¨æœŸï¼Œç›‘å¬å‡½æ•°ç­‰ã€‚

2 è¿™å¥—ç¼“å­˜é¡µé¢çš„æ€æƒ³ï¼Œä¸ä»…ä»…å¯ä»¥ç”¨åœ¨è·¯ç”±é¡µé¢çº§åˆ«ï¼ŒåæœŸå¯ä»¥è¿ç§»çš„`component`ç»„ä»¶çº§åˆ«ä¸Šæ¥ã€‚ä¹Ÿæ˜¯åç»­ç»´æŠ¤å’Œå¼€å‘çš„æ–¹å‘ã€‚



## ä½¿ç”¨ç®€ä»‹ + å¿«é€Ÿä¸Šæ‰‹

æˆ‘ä»¬å¼€å§‹è®¾è®¡é¡¹ç›®çš„ç”¨æ³•,apiï¼Œå·²ç»åº”ç”¨åœºæ™¯ã€‚é€šè¿‡ä¸Šè¿°å·¥ä½œåŸç†ï¼Œè®²è¿°äº† `keepliveRouteSwitch` å’Œ  `keepliveRoute` åœ¨æ•´ä¸ªç¼“å­˜è¿‡ç¨‹ä¸­çš„ä½œç”¨ï¼Œ




### ä¸‹è½½

å› ä¸ºæˆ‘ä»¬æ˜¯æŠŠé¡¹ç›®ä¸Šä¼ åˆ°äº†`npm`æ–¹ä¾¿å…¶ä»–é¡¹ç›®ç”¨ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ä» `npm` ä¸Šä¸‹è½½ã€‚


```bash
npm install react-keepalive-router --save
# or
yarn add react-keepalive-router
```

### ä½¿ç”¨

### 1 åŸºæœ¬ç”¨æ³•


#### KeepaliveRouterSwitch


`KeepaliveRouterSwitch`å¯ä»¥ç†è§£ä¸ºå¸¸è§„çš„Switch,ä¹Ÿå¯ä»¥ç†è§£ä¸º `keepaliveScope`,æˆ‘ä»¬**ç¡®ä¿æ•´ä¸ªç¼“å­˜ä½œç”¨åŸŸï¼Œåªæœ‰ä¸€ä¸ª `KeepaliveRouterSwitch` å°±å¯ä»¥äº†**ã€‚

#### å¸¸è§„ç”¨æ³•

````jsx
import { BrowserRouter as Router, Route, Redirect ,useHistory  } from 'react-router-dom'
import { KeepaliveRouterSwitch ,KeepaliveRoute ,addKeeperListener } from 'react-keepalive-router'

const index = () => {
  useEffect(()=>{
    /* å¢åŠ ç¼“å­˜ç›‘å¬å™¨ */
    addKeeperListener((history,cacheKey)=>{
      if(history)console.log('å½“å‰æ¿€æ´»çŠ¶æ€ç¼“å­˜ç»„ä»¶ï¼š'+ cacheKey )
    })
  },[])
  return <div >
    <div >
      <Router  >
      <Meuns/>
      <KeepaliveRouterSwitch>
          <Route path={'/index'} component={Index} ></Route>
          <Route path={'/list'} component={List} ></Route>
          { /* æˆ‘ä»¬å°†è¯¦æƒ…é¡µåŠ å…¥ç¼“å­˜ */ }
          <KeepaliveRoute path={'/detail'} component={ Detail } ></KeepaliveRoute>
          <Redirect from='/*' to='/index' />
       </KeepaliveRouterSwitch>
      </Router>
    </div>
  </div>
}
````


è¿™é‡Œåº”è¯¥æ³¨æ„âš ï¸çš„æ˜¯å¯¹äºå¤æ‚çš„è·¯ç”±ç»“æ„ã€‚æˆ–è€…KeepaliveRouterSwitch åŒ…è£¹çš„å­ç»„ä»¶ä¸æ˜¯Route ,æˆ‘ä»¬è¦ç»™ `KeepaliveRouterSwitch` å¢åŠ ç‰¹æœ‰çš„å±æ€§ `withoutRoute` å°±å¯ä»¥äº†ã€‚å¦‚ä¸‹ä¾‹å­ğŸŒ°ğŸŒ°ğŸŒ°ï¼š

**ä¾‹å­ä¸€**

````jsx
<KeepaliveRouterSwitch withoutRoute >
  <div>
     <Route path="/a" component={ComponentA}  />
     <Route path="/b" component={ComponentB}  />
     <KeepaliveRoute path={'/detail'} component={ Detail } ></KeepaliveRoute>
  </div>
</KeepaliveRouterSwitch>

````

**ä¾‹å­äºŒ**

æˆ–è€…æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ `renderRoutes` ç­‰`api`é…åˆ `KeepliveRouterSwitch` ä½¿ç”¨ ã€‚

````jsx
import {renderRoutes} from "react-router-config"
<KeepliveRouterSwitch withoutRoute  >{ renderRoutes(routes) }</KeepliveRouterSwitch> 
````


#### KeepaliveRoute

`KeepaliveRoute` åŸºæœ¬ä½¿ç”¨å’Œ `Route`æ²¡æœ‰ä»»ä½•åŒºåˆ«ã€‚


**åœ¨å½“å‰ç‰ˆæœ¬ä¸­âš ï¸âš ï¸âš ï¸å¦‚æœ `KeepaliveRoute` å¦‚æœæ²¡æœ‰è¢« `KeepaliveRouterSwitch`åŒ…è£¹å°±ä¼šå¤±å»ç¼“å­˜ä½œç”¨ã€‚**

**æ•ˆæœ**


![demoæ¼”ç¤º](https://raw.githubusercontent.com/AlienZhaolin/react-keepalive-router/master/md/111.gif)



### 2 å…¶ä»–åŠŸèƒ½



#### 1 ç¼“å­˜ç»„ä»¶æ¿€æ´»ç›‘å¬å™¨

å¦‚æœæˆ‘ä»¬å¸Œæœ›å¯¹å½“å‰æ¿€æ´»çš„ç»„ä»¶ï¼Œæœ‰ä¸€äº›é¢å¤–çš„æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥æ·»åŠ ç›‘å¬å™¨ï¼Œç”¨æ¥ç›‘å¬ç¼“å­˜ç»„ä»¶çš„æ¿€æ´»çŠ¶æ€ã€‚

````js
addKeeperListener((history,cacheKey)=>{
  if(history)console.log('å½“å‰æ¿€æ´»çŠ¶æ€ç¼“å­˜ç»„ä»¶ï¼š'+ cacheKey )
})
````
ç¬¬ä¸€ä¸ªå‚æ•°æœªhistoryå¯¹è±¡ï¼Œç¬¬äºŒä¸ªå‚æ•°ä¸ºå½“å‰ç¼“å­˜è·¯ç”±çš„å”¯ä¸€æ ‡è¯†cacheKey

#### 2 æ¸…é™¤ç¼“å­˜

ç¼“å­˜çš„ç»„ä»¶ï¼Œæˆ–æ˜¯è¢«`route`åŒ…è£¹çš„ç»„ä»¶ï¼Œä¼šåœ¨`props`å¢åŠ é¢å¤–çš„æ–¹æ³•`cacheDispatch`ç”¨æ¥æ¸…é™¤ç¼“å­˜ã€‚

å¦‚æœpropsæ²¡æœ‰`cacheDispatch`æ–¹æ³•ï¼Œå¯ä»¥é€šè¿‡


````js


import React from 'react'
import { useCacheDispatch } from 'react-keepalive-router'

function index(){
    const cacheDispatch = useCacheDispatch()
    return <div>æˆ‘æ˜¯é¦–é¡µ
        <button onClick={()=> cacheDispatch({ type:'reset' }) } >æ¸…é™¤ç¼“å­˜</button>
    </div>
}

export default index
````

**1 æ¸…é™¤æ‰€æœ‰ç¼“å­˜**

````js
cacheDispatch({ type:'reset' }) 
````

**2 æ¸…é™¤å•ä¸ªç¼“å­˜**

````js
cacheDispatch({ type:'reset',payload:'cacheId' }) 
````

**3 æ¸…é™¤å¤šä¸ªç¼“å­˜**

````js
cacheDispatch({ type:'reset',payload:['cacheId1'ï¼Œ'cacheId2'] }) 
````


**æ•ˆæœ**



## éªŒè¯é˜¶æ®µ

ç”±äºè¿™é‡Œä½¿ç”¨å…¬å¸é¡¹ç›®ä¸æ˜¯å¾ˆåˆé€‚ï¼Œæˆ‘ç”¨äº†ä¸€ä¸ªè‡ªå·±çš„é¡¹ç›®åš`demo`:


æ¥ä¸‹æ¥å°±æ˜¯éªŒè¯é˜¶æ®µé¦–å…ˆæˆ‘ä»¬çœ‹ä¸€ä¸‹äº§å“å°å§å§ç¬¬ä¸€ä¸ªéœ€æ±‚ï¼š




ç¬¬äºŒä¸ªéœ€æ±‚




å®Œç¾å®ç°äº§å“éœ€æ±‚ã€‚


## æ‰“åŒ…é˜¶æ®µ + å‘å¸ƒnpmé˜¶æ®µ


### rollupæ‰“åŒ…

æ¥ä¸‹æ¥å°±æ˜¯ `rollup` æ‰“åŒ…é˜¶æ®µï¼Œ`rollup`æ‰“åŒ…é˜¶æ®µã€‚é¡¹ç›®ç»“æ„æ˜¯è¿™æ ·çš„ã€‚


`rollup.config.js`æ˜¯æ•´ä¸ª`rollup`çš„é…ç½®æ–‡ä»¶ï¼Œç„¶åæˆ‘ä»¬é€šè¿‡ `rollup` æ‰“åŒ…åçš„æ–‡ä»¶å­˜åœ¨ `lib`æ–‡ä»¶å¤¹ä¸‹ã€‚



`rollup.config.js` å†…å®¹å¦‚ä¸‹

````js
import resolve from 'rollup-plugin-node-resolve'
import babel from 'rollup-plugin-babel'
import { uglify } from 'rollup-plugin-uglify'

export default [
    {
      input: 'src/index.js',
      output: {
        name: 'keepaliveRouter',
        file: 'lib/index.js',
        format: 'cjs',
        sourcemap: true
      },
      external: [
        'react',
        'react-router-dom',
        'invariant'
      ],
      plugins: [
        resolve(),
        babel({
          exclude: 'node_modules/**'
        })
      ]
    },
    /* å‹ç¼©` */
    {
      input: 'src/index.js',
      output: {
        name: 'keepaliveRouter',
        file: 'lib/index.min.js',
        format: 'umd'
      },
      external: [
        'react',
        'react-router-dom',
        'invariant'
      ],
      plugins: [
        resolve(),
        babel({
          exclude: 'node_modules/**'
        }),
        uglify()
      ]
    }
  ]
````


### å‘å¸ƒnpm

å¯¹äºå‘å¸ƒnpm

ç¬¬ä¸€æ­¥ï¼šéœ€è¦åœ¨`npm`æ³¨å†Œè´¦å·ã€‚`https://www.npmjs.com/signup`


ç¬¬äºŒæ­¥ï¼š ç™»é™† `npm login` 


ç¬¬ä¸‰æ­¥ï¼šåˆ›å»º `package.json`

````json
{
  "name": "react-keepalive-router", /* åç§° */
  "version": "1.1.0",  /* ç‰ˆæœ¬å· */
  "description": "åŸºäº`react 16.8+` ,`react-router 4+` å¼€å‘çš„`react`ç¼“å­˜ç»„ä»¶ï¼Œå¯ä»¥ç”¨äºç¼“å­˜é¡µé¢ç»„ä»¶ï¼Œç±»ä¼¼`vue`çš„`keepalive`åŒ…è£¹`vue-router`çš„æ•ˆæœåŠŸèƒ½ã€‚", /* æè¿° */
  "main": "index.js", /* å…¥å£æ–‡ä»¶ */
  "scripts": {
    "test": "echo \"Error: no test specified\" && exit 1",
    "build": "rollup --config"
  },
  "keywords": [  /* npm å…³é”®è¯ */
    "keep alive",
    "react",
    "react router",
    "react keep alive route",
    "react hooks"
  ],
  "homepage": "https://github.com/GoodLuckAlien/react-keepalive-router", /* æŒ‡å‘ github  */
  "peerDependencies": { /* npm é¡¹ç›®ä¾èµ– */
    "react": ">=16.8",
    "react-router-dom": ">=4",
    "invariant": ">=2"
  },
  "author": "alien",
  "license": "ISC",
  "devDependencies": {  /* å¼€å‘ç¯å¢ƒä¸‹ä¾èµ– */
    "@babel/core": "^7.12.3",
    "@babel/preset-react": "^7.12.5",
    "@babel/preset-env": "^7.12.1",
    "@babel/plugin-proposal-class-properties": "^7.12.1",
    "rollup": "^2.33.3",
    "rollup-plugin-node-resolve": "^5.2.0",
    "rollup-plugin-babel": "^4.4.0",
    "rollup-plugin-uglify": "^6.0.4"
  },
  "dependencies": { /* ç”Ÿäº§ç¯å¢ƒä¾èµ– */
    "invariant": "^2.2.4"
  }
}
````

ç¬¬å››æ­¥ï¼šä¸‡äº‹ä¿±å¤‡ä¹‹åï¼Œç”¨ `npm publish` å‘å¸ƒã€‚


ç¬¬äº”æ­¥ï¼šå‡çº§ç‰ˆæœ¬ï¼Œå‡çº§ç‰ˆæœ¬å¾ˆç®€å•ï¼Œéœ€è¦æˆ‘ä»¬åœ¨`package.json` å‡çº§ç‰ˆæœ¬å·ï¼Œç„¶åé‡æ–° `npm publish` å°±å¯ä»¥äº†ã€‚


**åºŸå¼ƒç‰ˆæœ¬å·**

å¦‚æœæˆ‘ä»¬æƒ³åºŸå¼ƒæŸä¸ªç‰ˆæœ¬ , æ‰§è¡Œå‘½ä»¤ `npm deprecate <pkg>[@<version>] <message>`

**åºŸå¼ƒåŒ…**

å¦‚æœæˆ‘ä»¬æƒ³åºŸå¼ƒåŒ… `npm unpublish <pkg> --force`

**`.npmignore`**

`.npmignore`é‡Œé¢å£°æ˜çš„æ–‡ä»¶å’Œæ–‡ä»¶ä»·åç§°ï¼Œä¸ä¼šè¢«ä¸Šä¼ åˆ° `npm` , æˆ‘çš„é¡¹ç›®é™¤äº† `README.md` ,`package.json` å’Œ `lib`   ä¸‹æ‰“åŒ…çš„æ–‡ä»¶ä¹‹å¤–ï¼Œå¤§éƒ¨åˆ†æ–‡ä»¶æ˜¯å¼€å‘æ—¶å€™æˆ–è€…ç¼–è¯‘é˜¶æ®µç”¨åˆ°çš„ï¼Œä¸éœ€è¦ä¸Šä¼ åˆ°`npm`ï¼Œæ‰€ä»¥éœ€è¦åœ¨ `.npmignore` è¿™ä¹ˆå†™

````js
docs
node_modules
src
md
.babelrc
.gitignore
.npmignore
.prettierrc
rollup.config.js
yarn.lock
````


## æ€»ç»“

ä»éœ€æ±‚åˆ°å¼€æºçš„æµç¨‹è·‘é€šä¹‹åï¼Œä¼šæœ‰å¾ˆå¤§çš„æˆå°±æ„Ÿï¼Œåˆšå¼€å§‹ç‹¬ç«‹å¼€å‘çš„é¡¹ç›®è‚¯å®šå¾ˆæœ‰å¾ˆå¤š`bug`,ä¸æ€•æœ‰`bug`ï¼Œè¦æœ‰ä¸€é¢—å‹‡äºä¿®å¤`bug`å¹¶æŠŠé¡¹ç›®ç»´æŠ¤ä¸‹å»çš„å†³å¿ƒã€‚



é€äººç«ç‘°ï¼Œæ‰‹ç•™ä½™é¦™ï¼Œé˜…è¯»çš„æœ‹å‹å¯ä»¥ç»™ç¬”è€…**ç‚¹èµï¼Œå…³æ³¨ä¸€æ³¢ã€‚**é™†ç»­æ›´æ–°å‰ç«¯æ–‡ç« ã€‚

æ„Ÿè§‰æœ‰ç”¨çš„æœ‹å‹å¯ä»¥å…³æ³¨ç¬”è€…å…¬ä¼—å·  **å‰ç«¯Sharing**  æŒç»­æ›´æ–°å‰ç«¯æ–‡ç« ã€‚

å–œæ¬¢ç¬”è€…çš„å¯ä»¥ç»™ç¬”è€…æŠ•ç¥¨ï¼Œæµ·æŠ¥å¦‚ä¸‹ğŸ™ğŸ™ğŸ™

