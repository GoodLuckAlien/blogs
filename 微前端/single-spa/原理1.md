

## registerApplication 注册应用

````js
import { registerApplication, start } from 'single-spa';
// or
import * as singleSpa from 'single-spa';
````

````js
singleSpa.registerApplication(
    'appName',
    () => System.import('appName'),
    location => location.pathname.startsWith('appName')
)
````

参数：
* appName ： 应用的名字将会在single-spa中注册和引用, 并在开发工具中标记。
* applicationOrLoadingFn ：必须是一个加载函数，返回一个应用或者一个Promise。
* activityFn： 必须是个纯函数, 该函数由
* 

**原理：**

````js
export function registerApplication(
  appNameOrConfig,  // app name 应用名称
  appOrLoadApp,     // System.import('appName'), 加载应用
  activeWhen,       // 必须是个纯函数, 该函数由 window.location 作为第一个参数被调用, 当应用应该被激活时它应该返回一个真值。
  customProps
){
   const registration = sanitizeArguments(
    appNameOrConfig,
    appOrLoadApp,
    activeWhen,
    customProps
  );
  /* 往 app 中添加应用 */
   apps.push(
    assign(
      {
        loadErrorTime: null,
        status: NOT_LOADED,
        parcels: {},
        devtools: {
          overlays: {
            options: {},
            selectors: [],
          },
        },
      },
      registration
    )
  );
   /* 在浏览器中 */
  if (isInBrowser) {
    ensureJQuerySupport();
    reroute();
  }
}
````

* sanitizeArguments -> 创建一个 registration 。
* 往 app 中添加应用
* 如果在浏览器中，那么 reroute。

## start 

````js
export function start(opts) {
  started = true;
  if (opts && opts.urlRerouteOnly) {
    setUrlRerouteOnly(opts.urlRerouteOnly);
  }
  if (isInBrowser) {
    reroute();
  }
}
````

* 设置开关 started = true
* 调用 start 本质上，调用 reroute


## reroute

reroute 用于加载和初始化应用。

````js
let appChangeUnderway = false
export function reroute(pendingPromises = [], eventArguments) {
     if (appChangeUnderway) {
            return new Promise((resolve, reject) => {
            peopleWaitingOnAppChange.push({
                resolve,
                reject,
                eventArguments,
            });
        });
    }
    /* 获取初始化参数 */
    const {
        appsToUnload,
        appsToUnmount,
        appsToLoad,
        appsToMount,
    } = getAppChanges(); 
    /*
     把所有的应用进行分类，
     Unload 没有加载 : NOT_BOOTSTRAPPED | NOT_MOUNTED   notActive ->  appsToUnload
     Mount  去挂载 NOT_BOOTSTRAPPED | NOT_MOUNTED beActive -> appsToMount
     Unmount 卸载 MOUNTED  notActive -> appsToUnmount
     Load   去加载 LOAD_ERROR ｜ TODO: NOT_LOADED   beActive  -> appsToLoad
    */

    /* 如果是 isStarted 证明不是第一次  */
    if (isStarted()) {
        appChangeUnderway = true;
        appsThatChanged = appsToUnload.concat(
        appsToLoad,
        appsToUnmount,
        appsToMount
        );
        /* 开始加载应用 */
        return performAppChanges();
    } else {
        /* 第一次走这里 */
        appsThatChanged = appsToLoad;
        return loadApps();
    }
     /* 第一次加载 */
    function loadApps(){
       return Promise.resolve().then(() => {
       const loadPromises = appsToLoad.map(toLoadPromise);
        /* promise 数组-> 第一层 [ promise<pendding> ] */
        return (
            Promise.all(loadPromises)
            .then(callAllEventListeners)
            // there are no mounted apps, before start() is called, so we always return []
            .then(() => [])
            .catch((err) => {
                callAllEventListeners();
                throw err;
            })
            );
       });   
    }

    /* 不是第一次的情况  */
    function performAppChanges(){
        /* 微任务执行 */
        return Promise.resolve().then(()=>{
            window.dispatchEvent(
                new CustomEvent(
                appsThatChanged.length === 0
                    ? "single-spa:before-no-app-change"
                    : "single-spa:before-app-change",
                getCustomEventDetail(true)
                )
            );

            window.dispatchEvent(
                new CustomEvent(
                "single-spa:before-routing-event",
                getCustomEventDetail(true, { cancelNavigation })
                )
           );

           /* 获取自定义事件详情 */
           function getCustomEventDetail(isBeforeChanges = false, extraProperties){

           }

        })
    }

}
````


## toLoadPromise 加载应用

````js
export function toLoadPromise(app) {
    return Promise.resolve().then(() => {
        /* 第一层 */
        return (app.loadPromise = Promise.resolve()
        .then(()=>{
            const loadPromise = app.loadApp(getProps(app));
            /* 加载函数本身 */
            return loadPromise.then((val)=>{
                //val 真正的应用
                appOpts = val;
                app.status = NOT_BOOTSTRAPPED;
                app.bootstrap = flattenFnArray(appOpts, "bootstrap");
                app.mount = flattenFnArray(appOpts, "mount");
                app.unmount = flattenFnArray(appOpts, "unmount");
                app.unload = flattenFnArray(appOpts, "unload");
                app.timeouts = ensureValidAppTimeouts(appOpts.timeouts);
            })
        })
    })
}
````

